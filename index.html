<!DOCTYPE html>
<html lang="hi">
<head>
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#0d6efd">

  <script>
  if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('service-worker.js');
  }
  </script>

  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>‡§ñ‡§∞‡•ç‡§ö‡§æ ‡§ñ‡§æ‡§§‡§æ / ‡§¨‡•à‡§Ç‡§ï ‡§ñ‡§æ‡§§‡§æ</title>

  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
<style>
  body {
    font-family: 'Noto Sans Devanagari', sans-serif;
    background: linear-gradient(135deg, #d1c4e9, #bbdefb);
    margin: 0; padding: 0;
    height: 100vh;
    display: flex;
    flex-direction: column;
  }
  header {
    background: #512da8;
    color: white;
    text-align: center;
    padding: 15px;
    font-size: 22px;
  }
  .screen { display: none; padding: 20px; text-align: center; }
  .active { display: block; }

  .account-btn {
    display: block;
    background: #4caf50;
    color: white;
    margin: 15px auto;
    padding: 15px;
    border-radius: 12px;
    width: 90%;
    font-size: 18px;
  }
  .account-btn:nth-child(2) { background: #2196f3; }

  .balance-box {
    background: white;
    border-radius: 10px;
    padding: 10px;
    margin: 10px auto;
    width: 90%;
    box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    position: sticky;
    top: 80px;
    z-index: 999;
  }

  .credit { color: blue; font-weight: bold; }
  .debit { color: red; font-weight: bold; }
  .balance { color: green; font-weight: bold; }

  table {
    width: 100%;
    background: white;
    border-collapse: collapse;
    border-radius: 10px;
    overflow: hidden;
  }
  th, td {
    border-bottom: 1px solid #ddd;
    padding: 8px;
    text-align: center;
  }
  th { background: #512da8; color: white; }

  button { border: none; border-radius: 6px; cursor: pointer; }
  .add-btn, .print-btn {
    background: #4caf50;
    color: white;
    padding: 10px;
    margin: 5px;
    width: 45%;
    border-radius: 10px;
    font-size: 16px;
  }
  .print-btn { background: #2196f3; }
  .edit-btn { background: #ff9800; color: white; padding: 6px 10px; }
  .delete-btn { background: #f44336; color: white; padding: 6px 10px; }
  .back-btn {
    background: #673ab7;
    color: white;
    padding: 10px 20px;
    border-radius: 8px;
    font-size: 16px;
  }

  .popup {
    display: none; justify-content: center; align-items: center;
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(0,0,0,0.6);
  }
  .popup-content {
    background: white;
    border-radius: 12px;
    padding: 15px;
    width: 85%; max-width: 330px;
  }

  input {
    width: 100%; padding: 8px; margin: 6px 0;
    border: 1px solid #ccc; border-radius: 6px;
    font-size: 16px;
  }

  .filters {
    display: flex;
    gap: 10px;
    justify-content: center;
    flex-wrap: wrap;
    margin-bottom: 10px;
  }

  .table-container {
    height: calc(100vh - 350px);
    overflow-y: auto;
  }

  /* ‚≠ê PRINT CLEAN MODE */
  @media print {

    header,
    .back-btn,
    .filters,
    .add-btn,
    .print-btn,
    #sortFilter,
    #typeFilter,
    #searchBox,
    #fromDate,
    #toDate,
    .popup,
    .account-btn,
    #homeScreen,
    h2,
    .balance-box {
      display: none !important;
    }

    #printHeading {
      display: block !important;
      text-align:center;
      font-size: 20px;
      font-weight: bold;
      margin-bottom: 15px;
      white-space: pre-line;
    }

    body { background: white !important; }

    .table-container {
      overflow: visible !important;
      height: auto !important;
    }

    table {
      width: 100% !important;
      border: 1px solid black !important;
    }

    th, td {
      border: 1px solid black !important;
    }

    td button {
      display: none !important;
    }
  }
</style>
</head>
<body>

<header>üíº ‡§ñ‡§∞‡•ç‡§ö‡§æ ‡§ñ‡§æ‡§§‡§æ / ‡§¨‡•à‡§Ç‡§ï ‡§ñ‡§æ‡§§‡§æ</header>

<div class="screen active" id="homeScreen">
  <h2>‡§ñ‡§æ‡§§‡•á ‡§ï‡§æ ‡§∏‡§æ‡§∞‡§æ‡§Ç‡§∂</h2>
  <div id="balanceCards">
    <div class="balance-box">
      üßæ ‡§ñ‡§∞‡•ç‡§ö‡§æ ‡§ñ‡§æ‡§§‡§æ - <span class="balance" id="kharchBalance">‚Çπ0</span>
    </div>
    <div class="balance-box">
      üè¶ ‡§¨‡•à‡§Ç‡§ï ‡§ñ‡§æ‡§§‡§æ - <span class="balance" id="bankBalance">‚Çπ0</span>
    </div>
  </div>
  <button class="account-btn" onclick="openLedger('kharchKhata')">üßæ ‡§ñ‡§∞‡•ç‡§ö‡§æ ‡§ñ‡§æ‡§§‡§æ ‡§ñ‡•ã‡§≤‡•á‡§Ç</button>
  <button class="account-btn" onclick="openLedger('bankKhata')">üè¶ ‡§¨‡•à‡§Ç‡§ï ‡§ñ‡§æ‡§§‡§æ ‡§ñ‡•ã‡§≤‡•á‡§Ç</button>
</div>

<div class="screen" id="ledgerScreen">
  <button class="back-btn" onclick="goHome()">üîô ‡§µ‡§æ‡§™‡§∏ ‡§ú‡§æ‡§è‡§Ç</button>
  <h2 id="ledgerTitle"></h2>

  <div class="balance-box">
    <span class="credit">Credit ‚Çπ<span id="creditTotal">0</span></span> |
    <span class="debit">Debit ‚Çπ<span id="debitTotal">0</span></span> |
    <span class="balance">Balance ‚Çπ<span id="balance">0</span></span>
  </div>

  <!-- ‚≠ê Print heading -->
  <h3 id="printHeading" style="display:none;"></h3>

  <div class="filters">
    <input type="date" id="fromDate">
    <input type="date" id="toDate">
    <input type="text" id="searchBox" placeholder="üîç ‡§µ‡§ø‡§µ‡§∞‡§£ ‡§∏‡•á ‡§ñ‡•ã‡§ú‡•á‡§Ç...">
  </div>

  <select id="sortFilter" style="padding:8px; border-radius:6px; font-size:15px;">
    <option value="new">üìÖ Newest First</option>
    <option value="old">üìÖ Oldest First</option>
  </select>

  <div style="margin-bottom:10px;">
    <select id="typeFilter" style="padding:8px; border-radius:6px; font-size:15px;">
      <option value="">‡§∏‡§≠‡•Ä</option>
      <option value="credit">‡§ï‡•á‡§µ‡§≤ Credit</option>
      <option value="debit">‡§ï‡•á‡§µ‡§≤ Debit</option>
    </select>
  </div>

  <button class="add-btn" onclick="openPopup()">‚ûï ‡§®‡§à Entry</button>
  <button class="print-btn" onclick="window.print()">üñ®Ô∏è Print</button>

  <div class="table-container">
    <table id="ledgerTable">
      <thead><tr><th>‡§§‡§æ‡§∞‡•Ä‡§ñ</th><th>‡§µ‡§ø‡§µ‡§∞‡§£</th><th>Credit</th><th>Debit</th><th>Action</th></tr></thead>
      <tbody></tbody>
    </table>
  </div>
</div>

<div class="popup" id="popupForm">
  <div class="popup-content">
    <h3 style="text-align:center;">‡§®‡§à ‡§è‡§Ç‡§ü‡•ç‡§∞‡•Ä ‡§ú‡•ã‡§°‡§º‡•á‡§Ç</h3>
    <label>‡§§‡§æ‡§∞‡•Ä‡§ñ</label>
    <input type="date" id="date">
    <label>‡§µ‡§ø‡§µ‡§∞‡§£</label>
    <input list="descList" type="text" id="desc" placeholder="‡§ú‡•à‡§∏‡•á Rent, Deposit...">
    <datalist id="descList"></datalist>
    <label style="color:blue;">üí∞ Credit ‡§∞‡§æ‡§∂‡§ø</label>
    <input type="number" id="credit" value="0">
    <label style="color:red;">üí∏ Debit ‡§∞‡§æ‡§∂‡§ø</label>
    <input type="number" id="debit" value="0">
    <div style="display:flex; justify-content:center;">
      <button class="popup-btn save-btn" onclick="saveNew()">üíæ Save</button>
      <button class="popup-btn cancel-btn" onclick="closePopup()">‚ùå Cancel</button>
    </div>
  </div>
</div>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<script>

const firebaseConfig = {
  apiKey: "AIzaSyADn_HUkP4ZfTOQ46eoQdXKIY7VAKd6odI",
  authDomain: "debit-4db50.firebaseapp.com",
  databaseURL: "https://debit-4db50-default-rtdb.asia-southeast1.firebasedatabase.app/",
  projectId: "debit-4db50",
  storageBucket: "debit-4db50.appspot.com",
  messagingSenderId: "495330105885",
  appId: "1:495330105885:web:18436900b881a1ee6b84f4"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.database();

let currentPath = "";
let allData = {};
let descSuggestions = new Set();

function openLedger(type){
  currentPath = type;
  document.getElementById('homeScreen').classList.remove('active');
  document.getElementById('ledgerScreen').classList.add('active');
  document.getElementById('ledgerTitle').innerText = type === 'kharchKhata' ? "‡§ñ‡§∞‡•ç‡§ö‡§æ ‡§ñ‡§æ‡§§‡§æ" : "‡§¨‡•à‡§Ç‡§ï ‡§ñ‡§æ‡§§‡§æ";
  loadLedger();
}

function goHome(){
  document.getElementById('ledgerScreen').classList.remove('active');
  document.getElementById('homeScreen').classList.add('active');
}

function openPopup(){
  document.getElementById("popupForm").style.display = "flex";
  document.getElementById("date").value = new Date().toISOString().split('T')[0];
  document.getElementById("desc").value = "";
  document.getElementById("credit").value = "0";
  document.getElementById("debit").value = "0";
}

function closePopup(){
  document.getElementById("popupForm").style.display = "none";
}

function saveNew(){
  const data = {
    date: date.value,
    desc: desc.value,
    credit: Number(credit.value),
    debit: Number(debit.value)
  };
  if(!data.desc) return alert("‡§µ‡§ø‡§µ‡§∞‡§£ ‡§¶‡§∞‡•ç‡§ú ‡§ï‡§∞‡•á‡§Ç!");
  db.ref(currentPath).push(data);
  descSuggestions.add(data.desc);
  updateDescList();
  closePopup();
}

function updateDescList(){
  const list = document.getElementById("descList");
  list.innerHTML = "";
  descSuggestions.forEach(v=>{
    const option = document.createElement("option");
    option.value = v;
    list.appendChild(option);
  });
}

function loadLedger(){
  db.ref(currentPath).on("value", snap=>{
    allData = snap.val() || {};
    renderTable();
  });
}

/* ‚≠ê FULL FILTER + PERFECT SORT ‚≠ê */
function renderTable(){
  const from = document.getElementById("fromDate").value;
  const to = document.getElementById("toDate").value;
  const search = document.getElementById("searchBox").value.toLowerCase();
  const typeFilter = document.getElementById("typeFilter").value;
  const sortType = document.getElementById("sortFilter").value;

  const monthValue = (!to && from) ? from.substring(0,7) : "";

  const tbody = document.querySelector("#ledgerTable tbody");
  tbody.innerHTML = "";

  let entries = Object.keys(allData).map(id => ({ id, ...allData[id] }));

  /* ‚≠ê SORT BLOCK FIXED */
  entries.sort((a, b) => {

    // ---------- NEWEST FIRST ----------
    if (sortType === "new") {
      let diff = b.date.localeCompare(a.date);
      if (diff !== 0) return diff;
      return b.id.localeCompare(a.id);   // newest same-day first
    }

    // ---------- OLDEST FIRST ----------
    else {
      let diff = a.date.localeCompare(b.date);
      if (diff !== 0) return diff;
      return a.id.localeCompare(b.id);   // oldest same-day first
    }
  });

  let c=0, d=0;

  entries.forEach(e => {

    if(from && to){
      if(e.date < from || e.date > to) return;
    }

    if(from && !to){
      if(e.date !== from){
        if(!(monthValue && e.date.startsWith(monthValue))){
          return;
        }
      }
    }

    if(search && !e.desc.toLowerCase().includes(search)) return;

    if(typeFilter === "credit" && e.credit <= 0) return;
    if(typeFilter === "debit" && e.debit <= 0) return;

    c += e.credit;
    d += e.debit;

    const tr=document.createElement("tr");
    tr.innerHTML=`
      <td>${e.date}</td>
      <td>${e.desc}</td>
      <td class='credit'>${e.credit}</td>
      <td class='debit'>${e.debit}</td>
      <td>
        <button class='edit-btn' onclick="editEntry('${e.id}',${e.credit},${e.debit},'${e.date}','${e.desc}')">‚úèÔ∏è</button>
        <button class='delete-btn' onclick="db.ref('${currentPath}/${e.id}').remove()">üóëÔ∏è</button>
      </td>`;
    tbody.appendChild(tr);

    descSuggestions.add(e.desc);
  });

  updateDescList();

  document.getElementById("creditTotal").innerText=c;
  document.getElementById("debitTotal").innerText=d;
  document.getElementById("balance").innerText=c-d;
  updateMainBalances();

  /* ‚≠ê PRINT HEADING AUTO */
  document.getElementById("printHeading").innerText =
    "SAINI TRADING COMPANY\n(" + document.getElementById("ledgerTitle").innerText + ")";
}

function editEntry(id, c, d, dateVal, descVal) {
  openPopup();
  document.getElementById("date").value = dateVal;
  document.getElementById("desc").value = descVal;
  document.getElementById("credit").value = c;
  document.getElementById("debit").value = d;

  const saveBtn = document.querySelector(".save-btn");
  saveBtn.onclick = () => {
    const updated = {
      date: document.getElementById("date").value,
      desc: document.getElementById("desc").value.trim(),
      credit: Number(document.getElementById("credit").value),
      debit: Number(document.getElementById("debit").value)
    };
    db.ref(`${currentPath}/${id}`).update(updated).then(() => {
      closePopup();
      saveBtn.onclick = saveNew;
    });
  };
}

function updateMainBalances(){
  ["kharchKhata","bankKhata"].forEach(path=>{
    db.ref(path).once("value",snap=>{
      let c=0,d=0;
      const data=snap.val()||{};
      Object.values(data).forEach(e=>{c+=e.credit;d+=e.debit});
      const bal=c-d;
      document.getElementById(path==="kharchKhata"?"kharchBalance":"bankBalance").innerText="‚Çπ"+bal;
    });
  });
}

document.getElementById("fromDate").addEventListener("input", renderTable);
document.getElementById("toDate").addEventListener("input", renderTable);
document.getElementById("searchBox").addEventListener("input", renderTable);
document.getElementById("typeFilter").addEventListener("change", renderTable);
document.getElementById("sortFilter").addEventListener("change", renderTable);

updateMainBalances();
</script>
</body>
</html>